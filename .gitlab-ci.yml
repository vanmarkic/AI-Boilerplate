# GitLab CI/CD Pipeline
# Mirrors GitHub Actions CI and adds security scanning stages.

workflow:
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

stages:
  - lint
  - test
  - build
  - security

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  NPM_CONFIG_CACHE: "$CI_PROJECT_DIR/.cache/npm"
  POSTGRES_DB: boilerplate_test
  POSTGRES_USER: dev
  POSTGRES_PASSWORD: dev
  FF_NETWORK_PER_BUILD: "true"

# ---------------------------------------------------------------------------
# Cache templates
# ---------------------------------------------------------------------------
.python-cache:
  cache:
    key: python-${CI_COMMIT_REF_SLUG}
    paths:
      - .cache/pip

.node-cache:
  cache:
    key: node-${CI_COMMIT_REF_SLUG}
    paths:
      - .cache/npm
      - frontend/node_modules

# ===========================================================================
# Lint Stage
# ===========================================================================

lint-architecture:
  stage: lint
  image: python:3.12-slim
  extends: .python-cache
  script:
    - pip install pyyaml
    - python shared/scripts/lint-architecture.py

lint-backend:
  stage: lint
  image: python:3.12-slim
  extends: .python-cache
  script:
    - cd backend
    - pip install ruff
    - ruff check .

lint-frontend:
  stage: lint
  image: node:22-slim
  extends: .node-cache
  script:
    - cd frontend
    - npm ci
    - npx ng lint

openapi-validate:
  stage: lint
  image: node:22
  extends: .node-cache
  script:
    - npx @redocly/cli lint shared/openapi.yaml

# ===========================================================================
# Test Stage
# ===========================================================================

test-backend:
  stage: test
  image: python:3.12-slim
  extends: .python-cache
  services:
    - name: postgres:17
      alias: postgres
      variables:
        POSTGRES_DB: boilerplate_test
        POSTGRES_USER: dev
        POSTGRES_PASSWORD: dev
  variables:
    DATABASE_URL: "postgresql+asyncpg://dev:dev@postgres:5432/boilerplate_test"
  script:
    - cd backend
    - pip install -e ".[dev]"
    - alembic upgrade head
    - python -m pytest -v --tb=short

test-frontend:
  stage: test
  image: node:22
  extends: .node-cache
  before_script:
    - apt-get update -qq && apt-get install -y -qq chromium > /dev/null 2>&1
    - export CHROME_BIN=/usr/bin/chromium
    - export CHROMIUM_FLAGS="--no-sandbox"
  script:
    - cd frontend
    - npm ci
    - npx ng test --watch=false --browsers=ChromeHeadless

# ===========================================================================
# Build Stage – Docker images (default branch & MRs only)
# ===========================================================================

.docker-build:
  stage: build
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - |
      if [ -n "$CI_REGISTRY" ] && [ -n "$CI_REGISTRY_USER" ]; then
        docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
      fi

build-backend-image:
  extends: .docker-build
  script:
    - docker build -t "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA" -f backend/Dockerfile .
    - |
      if [ -n "$CI_REGISTRY_IMAGE" ]; then
        docker push "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA"
      fi

build-frontend-image:
  extends: .docker-build
  script:
    - docker build -t "$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA" -f frontend/Dockerfile .
    - |
      if [ -n "$CI_REGISTRY_IMAGE" ]; then
        docker push "$CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA"
      fi

# ===========================================================================
# Security Stage – GitLab built-in security templates
# ===========================================================================
#
# These templates auto-detect languages and package managers. They produce
# reports that surface in the GitLab Security Dashboard and MR widgets.
# See: https://docs.gitlab.com/ee/user/application_security/

include:
  # Static Application Security Testing – finds vulnerabilities in source code
  - template: Security/SAST.gitlab-ci.yml
  # Secret Detection – flags accidentally committed credentials & tokens
  - template: Security/Secret-Detection.gitlab-ci.yml
  # Dependency Scanning – checks pip & npm dependencies against CVE databases
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  # Container Scanning – scans Docker images for OS-level vulnerabilities
  - template: Security/Container-Scanning.gitlab-ci.yml
  # License Scanning – reports dependency licenses for compliance review
  - template: Security/License-Scanning.gitlab-ci.yml

# Override template defaults to run in the security stage instead of test.
sast:
  stage: security

secret_detection:
  stage: security

dependency_scanning:
  stage: security

license_scanning:
  stage: security

container_scanning:
  stage: security
  variables:
    CS_IMAGE: "$CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA"
  needs:
    - build-backend-image

# ===========================================================================
# Custom Security Jobs
# ===========================================================================

security-npm-audit:
  stage: security
  image: node:22-slim
  extends: .node-cache
  script:
    - cd frontend
    - npm ci
    - npm audit --audit-level=high
  allow_failure: true

security-pip-audit:
  stage: security
  image: python:3.12-slim
  extends: .python-cache
  script:
    - pip install pip-audit
    - cd backend
    - pip install -e ".[dev]"
    - pip-audit
  allow_failure: true

security-trivy-fs:
  stage: security
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  script:
    - trivy fs --severity HIGH,CRITICAL --exit-code 1 .
  allow_failure: true
